# 实现计划: Chrome DevTools CLI

## 概述

使用 TypeScript 实现 Chrome DevTools CLI 工具，通过 WebSocket 连接与 Chrome 浏览器的 DevTools Protocol 通信，提供完整的命令行界面来控制浏览器操作。

## 任务

- [x] 1. 设置项目结构和核心接口
  - 创建 TypeScript 项目结构
  - 定义核心接口和类型定义
  - 设置测试框架（Jest + fast-check）
  - 配置构建和打包工具
  - _需求: 1.1, 9.1_

- [ ] 2. 实现 CDP 客户端核心功能
  - [ ] 2.1 实现 WebSocket 连接管理
    - 创建 CDPClient 类处理 WebSocket 连接
    - 实现消息 ID 生成和请求/响应匹配
    - 添加连接状态管理和事件监听
    - _需求: 1.1, 1.4_

  - [ ]* 2.2 为 CDP 客户端编写属性测试
    - **属性 1: 连接建立和管理**
    - **验证: 需求 1.1, 1.3, 1.4, 10.1, 10.2**

  - [x] 2.3 实现连接发现和管理
    - 创建 ConnectionManager 类
    - 实现目标发现（/json/list 端点）
    - 添加自动重连机制和指数退避
    - _需求: 1.2, 1.3, 10.5_

  - [ ]* 2.4 为连接管理编写单元测试
    - 测试连接发现功能
    - 测试重连机制
    - 测试错误处理
    - _需求: 1.2, 1.3, 10.5_

- [ ] 3. 检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户

- [x] 4. 实现 JavaScript 执行功能
  - [x] 4.1 实现 evaluate_script 命令处理器
    - 创建 EvaluateScriptHandler 类
    - 实现 Runtime.evaluate CDP 方法调用
    - 添加结果序列化和错误处理
    - 支持异步 JavaScript 和 Promise 等待
    - _需求: 3.1, 3.2, 3.3, 3.4_

  - [ ]* 4.2 为 JavaScript 执行编写属性测试
    - **属性 2: JavaScript 执行往返**
    - **验证: 需求 3.1, 3.2**

  - [ ]* 4.3 为 JavaScript 错误处理编写属性测试
    - **属性 3: JavaScript 错误处理**
    - **验证: 需求 3.3**

  - [ ]* 4.4 为异步 JavaScript 编写属性测试
    - **属性 4: 异步 JavaScript 执行**
    - **验证: 需求 3.4**

  - [x] 4.5 实现文件 JavaScript 执行支持
    - 添加从文件读取 JavaScript 代码功能
    - 实现超时处理机制
    - _需求: 3.6, 3.7_

  - [ ]* 4.6 为 DOM 修改编写属性测试
    - **属性 5: DOM 修改即时性**
    - **验证: 需求 3.5**

- [ ] 5. 实现页面管理功能
  - [ ] 5.1 实现页面导航命令
    - 创建 NavigatePageHandler 类
    - 实现 Page.navigate CDP 方法调用
    - 添加页面加载等待机制
    - _需求: 2.1_

  - [ ]* 5.2 为页面导航编写属性测试
    - **属性 6: 页面导航一致性**
    - **验证: 需求 2.1**

  - [ ] 5.3 实现页面管理命令（创建、关闭、列表、选择）
    - 创建 NewPageHandler、ClosePageHandler 等
    - 实现 Target.createTarget、Target.closeTarget 等 CDP 方法
    - 添加页面状态跟踪
    - _需求: 2.2, 2.3, 2.4, 2.5_

  - [ ]* 5.4 为页面管理编写属性测试
    - **属性 7: 页面管理操作**
    - **验证: 需求 2.2, 2.3, 2.4, 2.5**

  - [ ] 5.5 实现视口调整功能
    - 创建 ResizePageHandler 类
    - 实现 Emulation.setDeviceMetricsOverride CDP 方法
    - _需求: 2.6_

- [ ] 6. 检查点 - 确保核心功能正常工作
  - 确保所有测试通过，如有问题请询问用户

- [ ] 7. 实现元素交互功能
  - [ ] 7.1 实现基础元素交互（点击、悬停）
    - 创建 ClickHandler、HoverHandler 类
    - 实现 DOM.querySelector 和 Runtime.callFunctionOn CDP 方法
    - 添加元素查找和交互逻辑
    - _需求: 5.1, 5.4_

  - [ ]* 7.2 为元素交互编写属性测试
    - **属性 8: 元素交互幂等性**
    - **验证: 需求 5.1, 5.4**

  - [ ] 7.3 实现表单填充功能
    - 创建 FillHandler、FillFormHandler 类
    - 实现表单字段查找和值设置
    - 添加批量表单填充支持
    - _需求: 5.2, 5.3_

  - [ ]* 7.4 为表单填充编写属性测试
    - **属性 9: 表单填充往返**
    - **验证: 需求 5.2, 5.3**

  - [ ] 7.5 实现高级交互功能（拖拽、按键、文件上传）
    - 创建 DragHandler、PressKeyHandler、UploadFileHandler 类
    - 实现相应的 CDP 方法调用
    - 添加等待和对话框处理功能
    - _需求: 5.5, 5.6, 5.7, 5.8, 5.9_

- [ ] 8. 实现视觉捕获功能
  - [ ] 8.1 实现截图功能
    - 创建 TakeScreenshotHandler、TakeSnapshotHandler 类
    - 实现 Page.captureScreenshot CDP 方法
    - 添加文件保存和尺寸控制
    - _需求: 4.1, 4.2, 4.3, 4.4_

  - [ ]* 8.2 为截图功能编写属性测试
    - **属性 10: 截图文件创建**
    - **验证: 需求 4.1, 4.3, 4.4**

  - [ ] 8.3 实现 HTML 内容获取
    - 创建 GetHtmlHandler 类
    - 实现 DOM.getOuterHTML CDP 方法
    - _需求: 4.5_

- [ ] 9. 实现监控功能
  - [ ] 9.1 实现控制台消息监控
    - 创建 ConsoleMonitor 类
    - 实现 Runtime.consoleAPICalled 事件监听
    - 添加消息过滤和存储功能
    - _需求: 6.1, 6.2, 6.5, 6.6_

  - [ ]* 9.2 为控制台监控编写属性测试
    - **属性 11: 控制台消息捕获**
    - **验证: 需求 6.1, 6.2, 6.5**

  - [ ] 9.3 实现网络请求监控
    - 创建 NetworkMonitor 类
    - 实现 Network.requestWillBeSent、Network.responseReceived 事件监听
    - 添加请求/响应匹配和存储
    - _需求: 6.3, 6.4, 6.5, 6.6_

  - [ ]* 9.4 为网络监控编写属性测试
    - **属性 12: 网络请求监控**
    - **验证: 需求 6.3, 6.4, 6.5**

- [ ] 10. 实现性能分析功能
  - [ ] 10.1 实现性能跟踪
    - 创建 PerformanceTracker 类
    - 实现 Performance.enable、Performance.getMetrics CDP 方法
    - 添加跟踪数据收集和分析
    - _需求: 7.1, 7.2, 7.3, 7.4, 7.5_

  - [ ]* 10.2 为性能跟踪编写属性测试
    - **属性 13: 性能跟踪数据完整性**
    - **验证: 需求 7.1, 7.2, 7.4**

- [ ] 11. 实现设备模拟功能
  - [ ] 11.1 实现设备模拟
    - 创建 EmulateHandler 类
    - 实现 Emulation.setDeviceMetricsOverride、Emulation.setUserAgentOverride CDP 方法
    - 添加网络条件模拟支持
    - _需求: 8.1, 8.2, 8.3, 8.4_

  - [ ]* 11.2 为设备模拟编写属性测试
    - **属性 14: 设备模拟配置**
    - **验证: 需求 8.1, 8.2**

- [ ] 12. 检查点 - 确保所有功能模块正常工作
  - 确保所有测试通过，如有问题请询问用户

- [ ] 13. 实现 CLI 接口层
  - [ ] 13.1 实现命令行参数解析
    - 创建 CLIInterface 类
    - 使用 commander.js 实现参数解析
    - 添加配置文件支持
    - _需求: 9.1, 9.2, 9.3, 10.4_

  - [ ] 13.2 实现命令路由和执行
    - 创建命令注册和路由系统
    - 实现命令执行流程
    - 添加错误处理和退出代码管理
    - _需求: 9.4, 9.5_

  - [ ]* 13.3 为 CLI 接口编写单元测试
    - 测试参数解析功能
    - 测试命令路由
    - 测试错误处理
    - _需求: 9.2, 9.5_

- [ ] 14. 实现输出格式化
  - [ ] 14.1 实现输出格式化器
    - 创建 OutputFormatter 类
    - 实现 JSON 和文本格式输出
    - 添加静默和详细模式支持
    - _需求: 11.1, 11.2, 11.3, 11.4, 11.5_

  - [ ]* 14.2 为输出格式化编写属性测试
    - **属性 15: 输出格式一致性**
    - **验证: 需求 11.1, 11.2**

  - [ ]* 14.3 为错误退出代码编写属性测试
    - **属性 16: 错误退出代码**
    - **验证: 需求 9.5**

- [ ] 15. 集成和最终测试
  - [ ] 15.1 实现主程序入口
    - 创建 main.ts 文件
    - 连接所有组件
    - 添加全局错误处理
    - _需求: 所有需求_

  - [ ]* 15.2 编写集成测试
    - 测试端到端工作流程
    - 测试多命令组合使用
    - 测试长时间运行稳定性
    - _需求: 所有需求_

  - [ ] 15.3 创建构建和打包配置
    - 配置 TypeScript 编译
    - 创建可执行文件打包
    - 添加 npm 脚本和文档
    - _需求: 9.1_

- [ ] 16. 最终检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户

## 注意事项

- 标记为 `*` 的任务是可选的，可以跳过以加快 MVP 开发
- 每个任务都引用了具体的需求以便追溯
- 检查点确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证特定示例和边缘情况